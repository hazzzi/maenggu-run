=== Ralph Loop Progress ===

## 2025-01-18 - save-schema

**PRD**: save-schema (저장 스키마/경로)

**Completed**:
- SaveData, SaveDataStats 타입 정의
- MaengguState, Position 타입 정의
- IPC_CHANNELS 상수 정의
- DEFAULT_SAVE_DATA 기본값 정의
- 게임 상수 정의 (SAVE_DEBOUNCE_MS, IDLE_TIME_RANGE, MOVE_SPEED_RANGE 등)

**Files**:
- src/shared/types.ts (new)
- src/shared/constants.ts (new)
- electron/main.ts (unused import 제거)

**Decisions**:
- 기존 vite-plugin-electron 구조 유지 (electron-vite로 마이그레이션 안함)
- readonly 타입 사용으로 불변성 보장
- IPC 채널명을 상수로 중앙 관리

**Blockers**:
- oxlint 실행 불가 (Node ESM 호환성 문제) - 수정됨 (pnpm reinstall)

## 2025-01-18 - window-core

**PRD**: window-core (오버레이 창 기본 설정)

**Completed**:
- BrowserWindow 옵션 정의 (transparent, frame:false, alwaysOnTop, hasShadow:false, resizable:false)
- calculateCombinedDisplayBounds() - 모든 디스플레이 합산 영역 계산
- 오버레이 창 크기/위치에 합산 영역 적용
- setIgnoreMouseEvents(true, { forward: true }) 기본 적용
- setAlwaysOnTop('screen-saver') - macOS 최상위 레벨
- setContentProtection(true) - 스크린샷/녹화 보호
- contextIsolation: true, nodeIntegration: false - 보안 설정

**Files**:
- electron/main.ts (수정)

**Decisions**:
- screen.getAllDisplays() 사용하여 멀티모니터 bounding box 계산
- skipTaskbar: true, focusable: false로 시스템 UI 최소화
- DIP 좌표계 사용 (Retina 스케일링 자동 처리)

## 2025-01-18 - window-mouse + preload-api (partial)

**PRD**: window-mouse (클릭 통과 + 콜라이더 IPC)

**Completed**:
- main: mouse:collider IPC 핸들러 등록
- main: inCollider=true면 setIgnoreMouseEvents(false) 적용
- main: inCollider=false면 setIgnoreMouseEvents(true, { forward: true }) 적용
- preload: typed MaengguApi with mouse.setCollider exposed via contextBridge
- electron-env.d.ts: Window.maenggu 타입 선언

**Files**:
- electron/main.ts (ipcMain handler 추가)
- electron/preload.ts (MaengguApi 정의, contextBridge 노출)
- electron/electron-env.d.ts (Window 타입 보강)
- src/main.tsx (dead ipcRenderer code 제거)
- package.json (lint script 수정: --init → .)

**Decisions**:
- ipcRenderer 직접 노출 대신 typed API 노출 (보안/유지보수)
- MaengguApi 타입을 preload에서 export하여 type-safe window 접근

**Remaining (next iteration)**:
- renderer: 맹구 콜라이더 영역 계산 로직
- renderer: mousemove로 in/out 판정
- renderer: in/out 변화 시 IPC 송신

## 2025-01-18 - setup (프로젝트 구조 마이그레이션)

**PRD**: setup (프로젝트 초기 설정)

**Completed**:
- electron-vite 프로젝트 구조로 마이그레이션
  - electron/main.ts → src/main/index.ts
  - electron/preload.ts → src/preload/index.ts
  - src/*.tsx → src/renderer/
- 불필요한 템플릿 파일 제거
  - public/electron-vite.*.svg, public/vite.svg
  - src/assets/react.svg
  - src/App.css (템플릿 스타일)
  - index.html (루트) → src/renderer/index.html
- 오버레이 앱용 최소 CSS (transparent background)
- vite.config.ts 경로 수정
- tsconfig.json 업데이트 (include: src, types: node)
- @types/node 설치

**Files**:
- src/main/index.ts (new)
- src/preload/index.ts (new)
- src/renderer/index.tsx (new)
- src/renderer/App.tsx (new, minimal)
- src/renderer/index.css (new, overlay-ready)
- src/renderer/index.html (new)
- src/renderer/env.d.ts (new, Window.maenggu 타입)
- vite.config.ts (수정)
- tsconfig.json (수정)
- package.json (main entry 수정)
- 삭제: electron/, src/App.*, src/main.tsx, src/index.css, src/vite-env.d.ts, src/assets/, public/*.svg, index.html

**Decisions**:
- 구조 마이그레이션만 진행, vite-plugin-electron 유지
- 템플릿 데모 코드 완전 제거, 빈 App 컴포넌트로 시작
- preload → renderer 타입 참조를 src/renderer/env.d.ts에서 처리

## 2025-01-18 - save-load

**PRD**: save-load (저장 로드 흐름)

**Completed**:
- loadSaveData(): fs/promises로 저장 파일 읽기
- JSON 파싱 + ENOENT시 DEFAULT_SAVE_DATA 반환
- isValidSaveData(): 스키마 검증 (version, snacks, stats 필드)
- saveSaveData(): 저장 파일 쓰기 (mkdir recursive)
- IPC handler: save:load → ipcMain.handle로 등록
- preload: save.load() API 노출
- SaveLoadResult 타입 shared로 이동

**Files**:
- src/main/save.ts (new)
- src/main/ipc/save.ts (new)
- src/main/index.ts (registerSaveIpcHandlers 호출)
- src/preload/index.ts (save.load API 추가)
- src/shared/types.ts (SaveLoadResult 타입 추가)

**Decisions**:
- AGENTS.md 권장대로 IPC handlers를 src/main/ipc/ 분리
- 파일 없으면 에러 아닌 기본값 반환 (첫 실행 시나리오)
- schema validation 실패 시 error 반환 (save-error 카테고리에서 처리)
## 2025-01-18 - snack-state + preload-api-snack

**PRD**: snack-state (간식 상태 관리), preload-api-snack (preload API - snack)

**Completed**:
- SnackStateManager: in-memory state with add/spend/broadcast
- createSnackStateManager(): snacks counter + stats tracking
- getSnackState(): singleton pattern
- snack:add IPC handler (fire-and-forget)
- snack:spend IPC handler (returns boolean success)
- snack:update broadcast to all renderer windows
- preload: snack.add(), snack.spend(), snack.onUpdate() exposed
- main: initialize snack state from save on app start
- stats: totalClicks, totalFeedings, peakSnacks auto-updated

**Files**:
- src/main/snack-state.ts (new)
- src/main/ipc/snack.ts (new)
- src/main/index.ts (registerSnackIpcHandlers, loadSaveData → initializeFromSave)
- src/preload/index.ts (snack API added to MaengguApi)

**Decisions**:
- Singleton pattern for snack state (getSnackState)
- Broadcast pattern for state updates (IPC_CHANNELS.SNACK_UPDATE)
- onUpdate returns cleanup function (removeListener)
- add() increments totalClicks, spend() increments totalFeedings
- peakSnacks auto-tracked on add()

**Feedback Loops**:
- typecheck: ✅ pass
- lint: ✅ pass (0 warnings, 0 errors)
- test: ⚠️ no tests yet (expected)

## 2025-01-18 - save-debounce

**PRD**: save-debounce (저장 debounce)

**Completed**:
- debounce() utility function in src/shared/utils.ts (generic, typed, with cancel)
- save-scheduler.ts module: scheduleSave(), cancelPendingSave(), flushSave()
- scheduleSave() called after snack:add and snack:spend (on success only)
- flushSave() on app before-quit event to persist pending changes
- 500ms debounce delay from SAVE_DEBOUNCE_MS constant

**Files**:
- src/shared/utils.ts (new)
- src/main/save-scheduler.ts (new)
- src/main/ipc/snack.ts (modified, added scheduleSave calls)
- src/main/index.ts (modified, added flushSave on before-quit)

**Decisions**:
- Debounce util in shared/ for potential renderer reuse
- Only schedule save on successful spend (not failed attempts)
- flushSave cancels pending debounce then saves immediately on quit
- Error logging in performSave but non-blocking

**Feedback Loops**:
- typecheck: ✅ pass
- lint: ✅ pass (0 warnings, 0 errors)
- test: ⚠️ no tests yet (expected)
## 2025-01-18 - save-error

**PRD**: save-error (저장 손상 처리)

**Completed**:
- dialog.showMessageBox on load failure (type: error)
- Show error message with detail from saveResult.error
- app.quit() after dialog dismissed
- Blocking error: prevents window creation and app startup

**Files**:
- src/main/index.ts (added dialog import, error handling in app.whenReady)

**Decisions**:
- Block app startup on corrupted save (fail-fast principle)
- Single "Quit" button in error dialog (no recovery option)
- Error detail shown in dialog for debugging

**Feedback Loops**:
- typecheck: ✅ pass
- lint: ✅ pass (0 warnings, 0 errors)
- test: ⚠️ no tests yet (expected)
## 2025-01-18 - window-mouse-renderer

**PRD**: window-mouse-renderer (클릭 통과 콜라이더 - renderer)

**Completed**:
- useMouseCollider hook: tracks mouse position via window mousemove
- Bounds checking: getBoundingClientRect() collision detection
- State change optimization: only sends IPC when in/out state changes (via ref)
- Cleanup: resets collider state on unmount
- Placeholder Maenggu element: 64x64 semi-transparent div for testing
- pointerEvents: auto on Maenggu element (container remains none)

**Files**:
- src/renderer/hooks/useMouseCollider.ts (new)
- src/renderer/App.tsx (modified: added useRef, useMouseCollider, placeholder element)

**Decisions**:
- Custom hook pattern for reusability and separation of concerns
- useRef to track isInside state (avoids re-renders, only IPC on change)
- Placeholder styling inline (will be replaced by actual sprite rendering)
- Cleanup resets collider to false on unmount (prevents stuck state)

**Feedback Loops**:
- typecheck: ✅ pass
- lint: ✅ pass (0 warnings, 0 errors)
- test: ⚠️ no tests yet (expected)
## 2025-01-18 - anim-state

**PRD**: anim-state (애니메이션 상태 머신)

**Completed**:
- getNextAnimationState(): state transition guard + event mapping
- Defined AnimationEvent union for idle/walk/eat/happy transitions
- Added STATE_TRANSITIONS and EVENT_TO_STATE maps
- Unit tests for all transitions including invalid/force-idle

**Files**:
- src/renderer/animation/state-machine.ts (new)
- src/renderer/animation/state-machine.test.ts (new)

**Decisions**:
- Pure function + lookup tables for deterministic transitions
- Invalid events return current state (no-op)
- force-idle provides global override

**Feedback Loops**:
- typecheck: ✅ pass
- lint: ✅ pass (0 warnings, 0 errors)
- test: ✅ pass
## 2025-01-18 - sprite-loader

**PRD**: sprite-loader (스프라이트 로딩)

**Completed**:
- Sprite manifest for idle/walk/eat/happy frames
- getSpriteManifest() returns readonly frame lists
- getSpriteFrameUrls(basePath) builds full URLs with base path
- Unit tests for manifest and URL generation

**Files**:
- src/renderer/animation/sprite-loader.ts (new)
- src/renderer/animation/sprite-loader.test.ts (new)

**Decisions**:
- Manifest stored in code, not loaded dynamically (fast, deterministic)
- Base path normalized with trailing slash handling
- assets/ prefix assumed for sprite folder

**Feedback Loops**:
- typecheck: ✅ pass
- lint: ✅ pass (0 warnings, 0 errors)
- test: ✅ pass
## 2025-01-19 - prd-sync

**PRD**: Sync prd.json with actual progress

**Completed**:
- Updated prd.json: marked 6 completed tasks as passes=true
  - window-mouse-renderer
  - save-error
  - save-debounce
  - sprite-loader
  - anim-state
  - assets-sprites
- Verified sprite assets exist in ./assets/ (9 PNG files, 32x32, organized by state)
- Confirmed sprite-loader.ts matches actual sprite filenames

**Files**:
- prd.json (updated 6 task entries)

**Decisions**:
- Sprite assets already complete with proper structure
- All feedback loops pass (typecheck, lint, test)

**Feedback Loops**:
- typecheck: ✅ pass
- lint: ✅ pass (0 warnings, 0 errors)
- test: ✅ pass (9 tests in 2 files)
